@page "/cpd-changes"
@layout PageLayout
@using BootstrapBlazor.Components
@namespace BootstrapBlazor.Server.Components.Task9.CPD

<h3>üìà Thay ƒë·ªïi CPD - Content Performance Dashboard</h3>

<DemoBlock Title="Theo d√µi thay ƒë·ªïi CPD" Name="CpdChanges">
    <Table TItem="ChangeRow"
           AutoGenerateColumns="false"
           IsPagination="true"
           IsStriped="true"
           IsBordered="true"
           IsMultipleSelect="false"
           ShowColumnList="true"
           ShowToolbar="true"
           ShowDefaultButtons="false"
           ShowExtendButtons="false"
           ShowLoading="true"
           SearchMode="SearchMode.Top"
           CustomerSearchModel="@CustomerSearchModel" 
           ShowSearch="true"
           ShowCardView="true"
           OnQueryAsync="@OnQueryFilterAsync"
           @ref="TableRef">
        
        <TableColumns>
            <TableColumn Text="Publink" @bind-Field="@context.Publink">
                <Template Context="item">
                    <div class="d-flex flex-column">
                        <span class="fw-bold">@item.Row.Publink</span>
                        <small class="text-muted">@item.Row.Brand</small>
                    </div>
                </Template>
            </TableColumn>
            
            <TableColumn Text="Lo·∫°i thay ƒë·ªïi" @bind-Field="@context.ChangeType">
                <Template Context="item">
                    <Badge Color="@GetChangeTypeColor(item.Row.ChangeType)" class="fw-bold">
                        @GetChangeTypeText(item.Row.ChangeType)
                    </Badge>
                </Template>
            </TableColumn>
            
            <TableColumn Text="M·ª©c ƒë·ªô quan tr·ªçng" @bind-Field="@context.Importance">
                <Template Context="item">
                    <Badge Color="@GetImportanceColor(item.Row.Importance)" class="fw-bold">
                        @GetImportanceText(item.Row.Importance)
                    </Badge>
                </Template>
            </TableColumn>
            
            <TableColumn Text="C√°c tr∆∞·ªùng thay ƒë·ªïi" @bind-Field="@context.ChangeFlags">
                <Template Context="item">
                    <div class="d-flex flex-wrap gap-1">
                        @if (!string.IsNullOrEmpty(item.Row.ChangeFlags))
                        {
                            <Badge Color="Color.Info" class="small">
                                @item.Row.ChangeFlags
                            </Badge>
                        }
                    </div>
                </Template>
            </TableColumn>
            
            <TableColumn Text="Chi ti·∫øt thay ƒë·ªïi" @bind-Field="@context.ChangedColumns">
                <Template Context="item">
                    @if (item.Row.ChangedColumns != null)
                    {
                        <Button Color="Color.Primary" 
                                Size="Size.Small" 
                                Icon="fa-solid fa-eye"
                                OnClick="@(() => ShowChangeDetails(item.Row))"
                                title="Xem chi ti·∫øt thay ƒë·ªïi">
                        </Button>
                    }
                    else
                    {
                        <span class="text-muted">Kh√¥ng c√≥ chi ti·∫øt</span>
                    }
                </Template>
            </TableColumn>
            
            <TableColumn @bind-Field="@context.Position" Text="Position">
                <Template Context="item">
                    @item.Row.Position
                </Template>
            </TableColumn>
        </TableColumns>
        
        <CustomerSearchTemplate>
            @if (context is CpdChangesSearchFilterDto model)
            {
                <div class="row form-inline g-3">
                    <div class="col-12 col-sm-6">
                        <DateTimeRange @bind-Value="@model.DateRange"
                                       ViewMode="DatePickerViewMode.Date"
                                       DateFormat="dd/MM/yyyy"
                                       ShowLabel="true"
                                       DisplayText="Kho·∫£ng th·ªùi gian"
                                       ShowSidebar="true"
                                       AutoCloseClickSideBar="true">
                        </DateTimeRange>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <Select Items="ChangeTypeItems"
                                @bind-Value="model.ChangeType"
                                ShowSearch="false"
                                IsClearable="true"
                                ShowLabel="true"
                                DisplayText="Lo·∫°i thay ƒë·ªïi">
                        </Select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <Select Items="ImportanceItems"
                                @bind-Value="model.Importance"
                                ShowSearch="false"
                                IsClearable="true"
                                ShowLabel="true"
                                DisplayText="M·ª©c ƒë·ªô quan tr·ªçng">
                        </Select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <BootstrapInput @bind-Value="model.BusinessKeyHash" 
                                       ShowLabel="true" 
                                       DisplayText="Business Key Hash"
                                       Placeholder="T√¨m theo hash"/>
                    </div>
                    <div class="col-12 col-sm-12 btn-toolbar btn-group d-sm-inline-flex">
                        <Button OnClick="OnTriggerFilterQueryAsync" 
                                Text="T√¨m ki·∫øm" 
                                Icon="fa-solid fa-search" 
                                class="btn btn-success">
                        </Button>
                        <Button OnClick="OnResetFilter" 
                                Text="Reset" 
                                Icon="fa-solid fa-refresh" 
                                class="btn btn-secondary ms-2">
                        </Button>
                    </div>
                </div>
            }
        </CustomerSearchTemplate>
    </Table>
</DemoBlock>

<!-- Change Details Modal -->
<Modal @ref="ChangeDetailsModal" Size="Size.Large" IsCentered="true">
    <ModalDialog>
        <ModalHeader>
            <ModalTitle>Chi ti·∫øt thay ƒë·ªïi</ModalTitle>
        </ModalHeader>
        <ModalBody>
            @if (SelectedChangeItem != null)
            {
                <div class="change-details">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Publink:</strong> @SelectedChangeItem.Publink
                        </div>
                        <div class="col-6">
                            <strong>Brand:</strong> @SelectedChangeItem.Brand
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Lo·∫°i thay ƒë·ªïi:</strong> 
                            <Badge Color="@GetChangeTypeColor(SelectedChangeItem.ChangeType)">
                                @GetChangeTypeText(SelectedChangeItem.ChangeType)
                            </Badge>
                        </div>
                        <div class="col-6">
                            <strong>M·ª©c ƒë·ªô:</strong> 
                            <Badge Color="@GetImportanceColor(SelectedChangeItem.Importance)">
                                @GetImportanceText(SelectedChangeItem.Importance)
                            </Badge>
                        </div>
                    </div>
                    
                    @if (SelectedChangeItem.ChangedColumns != null)
                    {
                        <h6>Chi ti·∫øt c√°c tr∆∞·ªùng thay ƒë·ªïi:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Tr∆∞·ªùng</th>
                                        <th>Gi√° tr·ªã</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ChangeFlags</strong></td>
                                        <td>@SelectedChangeItem.ChangeFlags</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ChangedColumns</strong></td>
                                        <td>@SelectedChangeItem.ChangedColumns?.ToString()</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" OnClick="CloseChangeDetailsModal">
                ƒê√≥ng
            </Button>
        </ModalFooter>
    </ModalDialog>
</Modal>
